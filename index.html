<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TARIFUL 2.0 - External DB</title>
<style>
    /* Purono sob CSS ekhanei thakbe */
    *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
    body{background:#1a110f;color:#efdbd5;overflow-x:hidden; text-align: center; padding: 20px;}
    .db-box { background: #2a1f1d; padding: 20px; border-radius: 15px; border: 1px solid #8b442d; margin-bottom: 20px;}
    .btn { background: #8b442d; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; margin-top: 10px;}
    #mainApp, #authSection { display: none; }
    .auth-input { width: 80%; padding: 10px; margin: 5px; border-radius: 5px; border: none; }
</style>
</head>
<body>

<div id="setupSection" class="db-box">
    <h2>Storage Setup</h2>
    <p>Data permanent rakhar jonno device theke ekte file select korun.</p>
    <button class="btn" onclick="initDB()">Select/Create Database File</button>
</div>

<div id="authSection">
    <div class="db-box">
        <h2 id="authTitle">Login</h2>
        <input type="text" id="userIn" class="auth-input" placeholder="Username">
        <input type="password" id="passIn" class="auth-input" placeholder="Password">
        <br>
        <button class="btn" id="mainAuthBtn" onclick="handleAuth()">Login</button>
        <p onclick="toggleAuth()" style="cursor:pointer; margin-top:10px; font-size:12px; color:#d0ffda">Account nei? Register korun</p>
    </div>
</div>

<div id="mainApp">
    <h1 style="color:#d0ffda">Welcome to TARIFUL 2.0</h1>
    <p id="userDisplay"></p>
    <button class="btn" onclick="logout()">Logout</button>
    <hr style="margin:20px; border:0.5px solid #333">
    <h3>Calculator History</h3>
    <div id="histList"></div>
</div>

<script>
let fileHandle;
let database = { users: {}, history: {} };
let loggedInUser = "";
let isLoginMode = true;

// Device Storage Connect Kora
async function initDB() {
    try {
        [fileHandle] = await window.showOpenFilePicker({
            types: [{ description: 'JSON Database', accept: { 'application/json': ['.json'] } }],
            multiple: false
        }).catch(async () => {
            return [await window.showSaveFilePicker({ suggestedName: 'tariful_db.json' })];
        });

        const file = await fileHandle.getFile();
        const content = await file.text();
        if (content) database = JSON.parse(content);

        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('authSection').style.display = 'block';
        alert("Database Linked Successfully!");
    } catch (err) {
        alert("Storage access proyojon!");
    }
}

// Data File-e Save Kora
async function saveToDevice() {
    if (!fileHandle) return;
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(database));
    await writable.close();
}

function toggleAuth() {
    isLoginMode = !isLoginMode;
    document.getElementById('authTitle').innerText = isLoginMode ? "Login" : "Register";
    document.getElementById('mainAuthBtn').innerText = isLoginMode ? "Login" : "Register";
}

async function handleAuth() {
    const u = document.getElementById('userIn').value;
    const p = document.getElementById('passIn').value;

    if (isLoginMode) {
        if (database.users[u] === p) {
            loggedInUser = u;
            showApp();
        } else {
            alert("Wrong details!");
        }
    } else {
        if (database.users[u]) return alert("User exists!");
        database.users[u] = p;
        database.history[u] = [];
        await saveToDevice();
        alert("Registered! Now Login.");
        toggleAuth();
    }
}

function showApp() {
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').innerText = "Logged in as: " + loggedInUser;
    renderHistory();
}

function renderHistory() {
    const h = database.history[loggedInUser] || [];
    document.getElementById('histList').innerHTML = h.map(i => `<div>${i}</div>`).join('');
}

function logout() { location.reload(); }

// Calculator Calculation logic updated for device save
async function onCalculate(resultEntry) {
    database.history[loggedInUser].unshift(resultEntry);
    await saveToDevice();
    renderHistory();
}
</script>
</body>
</html>
