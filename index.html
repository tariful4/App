<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TARIFUL 2.0 - Cloud Edition</title>
    <style>
        /* CSS (‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤) */
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
        body{background:#1a110f;color:#efdbd5;overflow-x:hidden}
        #authSection {height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1a110f 0%, #2a1f1d 100%);}
        .auth-box {background: #2a1f1d; padding: 30px; border-radius: 20px; width: 90%; max-width: 360px; text-align: center; border: 1px solid #3e2e2a;}
        .auth-input {width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #553f38; background: #1a110f; color: white; outline: none;}
        .auth-btn {width: 100%; padding: 12px; background: #8b442d; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px;}
        #mainApp { display: none; }
        .section { display: none; padding: 15px; }
        .calc-box{max-width:360px;margin:auto}
        .screen{height:90px;font-size:2.2rem;text-align:right;padding:10px;background:#2a1f1d;border-radius:15px;margin-bottom:15px;overflow:hidden}
        .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
        .btn{height:60px;border:none;border-radius:50%;font-size:1.2rem;cursor:pointer}
        .num{background:#352d2b;color:white} .ac{background:#8b442d;color:white}
        .eq{background:#f7e3a0;color:#3e2e00;border-radius:30px}
        #historyPanel{margin-top:20px; background:#2a1f1d; padding:15px; border-radius:15px; max-height: 200px; overflow-y: auto;}
        .hist-item{padding:8px 0; border-bottom:1px solid #352d2b; font-size: 0.9rem;}
    </style>
</head>
<body>

<div id="authSection">
    <div class="auth-box" id="authBox">
        <h2 id="authTitle">TARIFUL 2.0 Login</h2>
        <input type="text" id="userInput" class="auth-input" placeholder="Username">
        <input type="password" id="passInput" class="auth-input" placeholder="Password">
        <button class="auth-btn" id="submitBtn">Login</button>
        <p onclick="toggleAuth()" id="toggleMsg" style="color:#d0ffda; margin-top:15px; cursor:pointer; font-size:0.8rem;">New User? Register here</p>
    </div>
</div>

<div id="mainApp">
    <div id="home" style="text-align:center; padding-top:100px;">
        <h1 style="color:#d0ffda">TARIFUL 2.0</h1>
        <button onclick="openCalc()" style="width:80%; padding:20px; margin-top:20px; background:#8b442d; color:white; border-radius:15px; border:none; font-weight:bold;">üßÆ Open Calculator</button>
        <br>
        <button onclick="location.reload()" style="margin-top:30px; background:none; border:1px solid #8b442d; color:#8b442d; padding:5px 15px; border-radius:10px;">Logout</button>
    </div>

    <div id="calcSec" class="section">
        <button onclick="goHome()" style="background:#352d2b; color:white; border:none; padding:8px 15px; border-radius:20px; margin-bottom:10px;">‚Üê Back</button>
        <div class="calc-box">
            <div class="screen" id="disp">0</div>
            <div class="grid">
                <button class="btn ac" onclick="clr()">AC</button>
                <button class="btn num" onclick="add('/')">√∑</button>
                <button class="btn num" onclick="add('*')">√ó</button>
                <button class="btn num" onclick="bk()">‚å´</button>
                <button class="btn num" onclick="add('7')">7</button>
                <button class="btn num" onclick="add('8')">8</button>
                <button class="btn num" onclick="add('9')">9</button>
                <button class="btn num" onclick="add('-')">‚àí</button>
                <button class="btn eq" onclick="runCalc()" style="grid-column: span 4; margin-top:10px">=</button>
            </div>
        </div>
        <div id="historyPanel">
            <h4 style="color:#d0ffda">Cloud History (Last 10)</h4>
            <div id="histList">Loading...</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    const firebaseConfig = {
        apiKey: "AIzaSyA2T1xkIsdNh7UyT6dTgKHYGCEgEVQ4bj0",
        authDomain: "my-social-project-73e01.firebaseapp.com",
        projectId: "my-social-project-73e01",
        storageBucket: "my-social-project-73e01.firebasestorage.app",
        messagingSenderId: "944631362614",
        appId: "1:944631362614:web:ef49c81e235125a6db9497",
        measurementId: "G-ER6LWM02Q7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUsername = "";
    let isLoginMode = true;

    // ‡¶≤‡¶ó‡¶á‡¶®/‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®
    window.toggleAuth = () => {
        isLoginMode = !isLoginMode;
        document.getElementById("authTitle").innerText = isLoginMode ? "TARIFUL 2.0 Login" : "Create Account";
        document.getElementById("submitBtn").innerText = isLoginMode ? "Login" : "Register";
        document.getElementById("toggleMsg").innerText = isLoginMode ? "New User? Register here" : "Already have account? Login";
    };

    // ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® (Login/Register)
    document.getElementById("submitBtn").onclick = async () => {
        const user = document.getElementById("userInput").value.trim();
        const pass = document.getElementById("passInput").value.trim();
        if(!user || !pass) return alert("Please fill all fields!");

        const userRef = doc(db, "users", user);
        const snap = await getDoc(userRef);

        if(isLoginMode) {
            if(snap.exists() && snap.data().password === pass) {
                currentUsername = user;
                loginSuccess();
            } else alert("Invalid Username or Password!");
        } else {
            if(snap.exists()) alert("Username already taken!");
            else {
                await setDoc(userRef, { password: pass, history: [] });
                alert("Registration Successful! Now Login.");
                toggleAuth();
            }
        }
    };

    function loginSuccess() {
        document.getElementById("authSection").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        loadHistory();
    }

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶∏‡ßá‡¶≠
    window.saveToCloud = async (log) => {
        const userRef = doc(db, "users", currentUsername);
        await updateDoc(userRef, { history: arrayUnion(log) });
        loadHistory();
    };

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶°
    async function loadHistory() {
        const userRef = doc(db, "users", currentUsername);
        const snap = await getDoc(userRef);
        const h = snap.data().history || [];
        document.getElementById("histList").innerHTML = h.slice(-10).reverse().map(i => `<div class="hist-item">${i}</div>`).join("");
    }
</script>

<script>
    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π
    function add(v){ let d=document.getElementById("disp"); d.innerText = d.innerText==="0"?v:d.innerText+v; }
    function clr(){ document.getElementById("disp").innerText="0"; }
    function bk(){ let d=document.getElementById("disp"); d.innerText = d.innerText.length>1?d.innerText.slice(0,-1):"0"; }
    function openCalc(){ document.getElementById("home").style.display="none"; document.getElementById("calcSec").style.display="block"; }
    function goHome(){ document.getElementById("calcSec").style.display="none"; document.getElementById("home").style.display="block"; }

    async function runCalc(){
        let d = document.getElementById("disp");
        try {
            let res = eval(d.innerText);
            let log = d.innerText + " = " + res;
            d.innerText = res;
            // ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
            if(window.saveToCloud) await window.saveToCloud(log);
        } catch { d.innerText = "Error"; }
    }
</script>

</body>
</html>
